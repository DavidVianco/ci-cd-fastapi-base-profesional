name: CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  lint-tests:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/py-setup
      - name: Lint & format
        run: |
          uv sync --all-extras --dev
          ruff format . --check | tee ruff-format.log
          uv run ruff check . | tee ruff-check.log

      - name: failure control
        if: failure()
        run: |
          echo "--- ruff logs fail ---"

  build:
    needs: [lint-tests]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/py-setup
      - name: Build App
        run: uv build

      - name: Upload App Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app
          path: dist/*.whl
          retention-days: 1
      - name: pene
        run: |
          ls dist/
          cat dist/proyecto_cicd-0.1.0-py3-none-any.whl
          ls dist/proyecto_cicd-0.1.0.tar.gz
  app-tests:
    needs: [build]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/py-setup
      - name: Download App
        uses: actions/download-artifact@v4
        with:
          name: app
          path: dist/
      - name: Install from Wheel
        run: uv pip install dist/*.whl

      - name: Run App tests
        run: |
          mkdir -p reports
          uv run pytest --junitxml=reports/junit.xml --cov=. --cov-report=xml:reports/coverage.xml | tee reports/pytest.log

      - name: Upload test reports
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: reports/coverage.xml
          retention-days: 1

      - name: failure control
        if: failure()
        run: |
          echo "--- pytest logs fail ---"

  e2e-tests:
    needs: [build]
    timeout-minutes: 15
    runs-on: ubuntu-24.04
    container:
      image: cypress/browsers:22.20.0
      options: --user 1001

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/py-setup
        with:
          enable-cache: false
      - name: Download App
        uses: actions/download-artifact@v4
        with:
          name: app
          path: dist/
      - name: Install from Wheel
        run: uv pip install dist/*.whl

      - name: iniciar server
        run: |
          uv run uvicorn main:app \
          --port 8000 \
          --host 0.0.0.0 \
          > e2e-test.log 2>&1 &

      - name: Run Cypress tests
        uses: cypress-io/github-action@v6
        with:
          wait-on: http://localhost:8000/health
          wait-on-timeout: 60
      - name: failure control
        if: failure()
        run: |
          echo "--- e2e logs fail ---"

  scan-vulnerabilities:
    needs: [e2e-tests, app-tests]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download test reports
        uses: actions/download-artifact@v4
        with:
          name: test-reports
          path: reports/
      - name: sonar-qube-scan
        uses: SonarSource/sonarqube-scan-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: SonarQube Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  deploy:
    needs: scan-vulnerabilities
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: app
          path: dist/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Tag Image
        run: |
          docker build -t mi-app:1.0 .
          echo "Imagen construida exitosamente"

  pipeline-summary:
    if: always()
    needs:
      - lint-tests
      - app-tests
      - e2e-tests
      - scan-vulnerabilities
      - deploy
    runs-on: ubuntu-24.04
    steps:
      - name: Summary
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Lint: ${{ needs.lint-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- App tests: ${{ needs.app-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2E tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security scan: ${{ needs.scan-vulnerabilities.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
